"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),_get=function(e,t,n){for(var s=!0;s;){var a=e,i=t,r=n;u=l=o=void 0,s=!1,null===a&&(a=Function.prototype);var u=Object.getOwnPropertyDescriptor(a,i);if(void 0!==u){if("value"in u)return u.value;var o=u.get;return void 0===o?void 0:o.call(r)}var l=Object.getPrototypeOf(a);if(null===l)return void 0;e=l,t=i,n=r,s=!0}},ImplemetationError=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),t}(Error),Optional=function(){function e(t){_classCallCheck(this,e),this.content=t}return _createClass(e,[{key:"isPresent",value:function(){return null==this.content}}],[{key:"of",value:function(t){return new e(t)}},{key:"empty",value:function(){return new e(null)}}]),e}(),PedalController=function(){function e(t){_classCallCheck(this,e),this.controllerListenners=new Array,this.realMultistompListenners=new Array,this.realChange=!1,this.started=!1,this.pedal=t,this.connection=new MidiConnection(t,t.getPedalType()),this.connection.setListenner(this),this.pedal.addListenner(this),this.controllerListenners.add(new Log("Controller")),this.realMultistompListenners.add(new Log("Real Multistomp"))}return _createClass(e,[{key:"on",value:function(){this.started||(this.started=!0,this.connection.start(),this.connection.send(this.pedal.start()),this.realChange=!1)}},{key:"off",value:function(){started||(this.started=!1,this.connection.stop())}},{key:"hasStarted",value:function(){return this.started}},{key:"multistomp",value:function(){return this.pedal}},{key:"nextPatch",value:function(){this.pedal.nextPatch()}},{key:"beforePatch",value:function(){this.pedal.beforePatch()}},{key:"toPatch",value:function(e){this.pedal.toPatch(e)}},{key:"toogleEffect",value:function(e){this.pedal.currentPatch().effects().get(e).toggle()}},{key:"hasActived",value:function(e){return this.pedal.currentPatch().effects().get(e).hasActived()}},{key:"activeEffect",value:function(e){this.pedal.currentPatch().effects().get(e).active()}},{key:"disableEffect",value:function(e){this.pedal.currentPatch().effects().get(e).disable()}},{key:"setEffectParam",value:function(e,t,n){this.pedal.currentPatch().effects().get(e).params().get(t).setValue(n)}},{key:"getAmountEffects",value:function(){return this.pedal.currentPatch().effects().size()}},{key:"addListenner",value:function(e){this.pedal.addListenner(e)}},{key:"toString",value:function(){var e="State: ";return e+=started?"On":"Off",e+="\n",e+this.pedal.toString()}},{key:"onChange",value:function(e){return this.realChange?void(this.realChange=!1):(this.connection.send(e),void this.notify(this.controllerListenners,e))}},{key:"update",value:function(e){this.realChange=!0;var t=new MultistompChanger(this);e.forEach(function(e){return t.attempt(e)}),this.notify(realMultistompListenners,e)}},{key:"notify",value:function(e,t){var n=!0,s=!1,a=void 0;try{for(var i,r=e[Symbol.iterator]();!(n=(i=r.next()).done);n=!0)listenner=i.value,listenner.onChange(t)}catch(u){s=!0,a=u}finally{try{!n&&r["return"]&&r["return"]()}finally{if(s)throw a}}}},{key:"sendMessage",value:function(e){this.connection.send(e)}},{key:"send",value:function(e){this.connection.send(e),this.realChange=!0}}]),e}(),MidiConnection=function(){function e(t,n){_classCallCheck(this,e),this.listenner=Optional.empty(),this.multistomp=t,this.sender=new MidiSender(n),this.reader=new MidiReader(n),this.reader.setListenner(this),this.encoder=MessageEncoderFactory.For(n),this.decoder=MessageDecoderFactory.For(n)}return _createClass(e,[{key:"start",value:function(){this.sender.start(),this.reader.start()}},{key:"stop",value:function(){this.sender.stop(),this.reader.stop()}},{key:"send",value:function(e){var t=!0,n=!1,s=void 0;try{for(var a,i=this.generateMidiMessages(e)[Symbol.iterator]();!(t=(a=i.next()).done);t=!0)midiMessage=a.value,this.send(midiMessage)}catch(r){n=!0,s=r}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw s}}}},{key:"generateMidiMessages",value:function(e){return encoder.encode(e)}},{key:"send",value:function(e){console.log("MIDI sended: "),console.log(" "+BinarioUtil.byteArrayToHex(e.getMessage())),this.sender.send(e)}},{key:"setListenner",value:function(e){this.listenner=Optional.of(e)}},{key:"onDataReceived",value:function(e){return console.log("MIDI received: "),console.log(" "+BinarioUtil.byteArrayToHex(e.getMessage())),this.decoder.isForThis(e)?(messagesDecoded=this.decoder.decode(e,this.multistomp),void(this.listenner.isPresent()&&this.listenner.get().update(messagesDecoded))):void console.log(" unknown ")}}]),e}(),Effect=function(){function e(t,n){_classCallCheck(this,e),this.state=!1,this.params=new Array,this.listenner=Optional.empty(),this.midiId=t,this.name=n}return _createClass(e,[{key:"getMidiId",value:function(){return this.midiId}},{key:"getName",value:function(){return this.name}},{key:"active",value:function(){this.setState(!0)}},{key:"disable",value:function(){this.setState(!1)}},{key:"toggle",value:function(){this.hasActived()?this.disable():this.active()}},{key:"setState",value:function(e){this.state=e;var t=new Details(TypeChange.PEDAL_STATUS,e?1:0),n=new ChangeMessage(MultistompCause.EFFECT,this,t);this.notify(n)}},{key:"hasActived",value:function(){return state}},{key:"addParam",value:function(e){this.params.push(e),e.setListenner(this)}},{key:"params",value:function(){return this.params}},{key:"toString",value:function(){var t=this.name+": "+this.midiId+" "+e.name+" - ";t+=this.state?"Actived":"Disabled";var n=!0,s=!1,a=void 0;try{for(var i,r=this.params[Symbol.iterator]();!(n=(i=r.next()).done);n=!0){var u=i.value;t+=u.toString()}}catch(o){s=!0,a=o}finally{try{!n&&r["return"]&&r["return"]()}finally{if(s)throw a}}return t+=")"}},{key:"setListenner",value:function(e){this.listenner=Optional.of(e)}},{key:"onChange",value:function(e){newMessage=new ChangeMessage(MultistompCause.SUPER,this,e),this.notify(newMessage)}},{key:"notify",value:function(e){this.listenner.isPresent()&&this.listenner.get().onChange(e)}}]),e}(),Multistomp=function(){function e(){_classCallCheck(this,e),this.listenners=new Array,this.patchs=new Array,this.idCurrentPatch=0}return _createClass(e,[{key:"getPedalType",value:function(){}},{key:"addPatch",value:function(e){this.patchs.push(e),e.setListenner(this)}},{key:"currentPatch",value:function(){try{return this.patchs[this.idCurrentPatch]}catch(e){throw new ImplemetationError("This multistomp havent any Patch. \nAdd the Patchs in the Pedal Construtor: "+this.name)}}},{key:"getIdCurrentPatch",value:function(){return this.idCurrentPatch}},{key:"nextPatch",value:function(){this.toPatch(this.idCurrentPatch+1)}},{key:"beforePatch",value:function(){this.toPatch(this.idCurrentPatch-1)}},{key:"toPatch",value:function(e){e>=this.patchs.length?e=0:0>e&&(e=this.patchs.length-1),this.idCurrentPatch=e;{var t=new Details(Details.TypeChange.PATCH_NUMBER,this.idCurrentPatch);new ChangeMessage(MultistompCause.MULTISTOMP,this,t)}}},{key:"patchs",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){return patchs})},{key:"toString",value:function(){var t="";t+="Multistomp: "+e.name+"\n",t+=" - Current Patch: "+this.currentPatch().toString()+"\n",t+=" - Effects: \n";var n=!0,s=!1,a=void 0;try{for(var i,r=this.currentPatch().effects[Symbol.iterator]();!(n=(i=r.next()).done);n=!0){var u=i.value;t+="  |- "+u.toString()+"\n"}}catch(o){s=!0,a=o}finally{try{!n&&r["return"]&&r["return"]()}finally{if(s)throw a}}return t}},{key:"addListenner",value:function(e){this.listenners.push(e)}},{key:"listenners",value:function(){return this.listenners}},{key:"onChange",value:function(e){var t=new ChangeMessage(MultistompCause.SUPER,this,e);this.notify(t)}},{key:"notify",value:function(e){var t=MultistompMessagesConverter.convert(e);this.listenners.forEach(function(e){return e.onChange(t)})}},{key:"start",value:function(){}}]),e}(),MultistompMessagesConverter=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"convert",value:function(e){var t=null,n=Messages.Details();return e.is(MultistompCause.MULTISTOMP)?t=convertToPatch(e,n):e.is(MultistompCause.EFFECT)?t=convertStatusEffect(e,n):e.is(MultistompCause.PATCH)&&(t=convertSetParam(e,n)),null!=t?Messages.For(t):Messages.For()}},{key:"convertToPatch",value:function(e,t){return t.patch=e.causer().getIdCurrentPatch(),new Message(CommonCause.TO_PATCH,t)}},{key:"convertStatusEffect",value:function(e,t){var n=e.nextMessage().causer();t.patch=e.causer().patchs().indexOf(n);var s=e.realMessage().causer(),a=n.effects().indexOf(s);t.effect=a;var i=s.hasActived()?CommonCause.ACTIVE_EFFECT:CommonCause.DISABLE_EFFECT;return new Message(i,t)}},{key:"convertSetParam",value:function(e,t){var n=e.nextMessage().causer(),s=e.nextMessage().nextMessage().causer(),a=n.effects().indexOf(s);return t.effect=a,t.param=s.params().indexOf(e.realMessage().causer()),t.value=e.realMessage().causer().getValue(),new Message(CommonCause.SET_PARAM,t)}}]),e}(),Param=function(){function e(t,n,s,a,i){_classCallCheck(this,e),this.stepByStep=1,this.listenner=Optional.empty(),this.name=t,this.minValue=n,this.maxValue=s,this.setCurrentValue(a),this.stepByStep=i}return _createClass(e,[{key:"setCurrentValue",value:function(e){this.isValidValue(e)||(e=e>this.maxValue?this.maxValue:this.minValue),this.currentValue=e}},{key:"isValidValue",value:function(e){return!(e<this.minValue||e>this.maxValue)}},{key:"notify",value:function(e){this.listenner.isPresent()&&this.listenner.get().onChange(e)}},{key:"getName",value:function(){return this.name}},{key:"getValue",value:function(){return currentValue}},{key:"setValue",value:function(e){this.setCurrentValue(e)}},{key:"addValue",value:function(){var e=this.currentValue+this.stepByStep;this.isValidValue(e)&&this.setValue(e)}},{key:"getMinValue",value:function(){return this.minValue}},{key:"getMaxValue",value:function(){return this.maxValue}},{key:"setListenner",value:function(e){this.listenner=Optional.of(e)}},{key:"toString",value:function(){return this.name+" = "+this.currentValue+" ["+this.minValue+" - "+this.maxValue+"]"}}]),e}(),Patch=function(){function e(t){_classCallCheck(this,e),this.name="",this.effects=new Array,this.listenner=Optional.empty(),this.id=t}return _createClass(e,[{key:"getId",value:function(){return id}},{key:"addEffect",value:function(e){this.effects.push(e),e.setListenner(this)}},{key:"setListenner",value:function(e){this.listenner=Optional.of(e)}},{key:"onChange",value:function(e){var t=new ChangeMessage(MultistompCause.SUPER,this,e);this.notify(t)}},{key:"notify",value:function(e){this.listenner.isPresent()&&this.listenner.get().onChange(e)}},{key:"toString",value:function(){return"Patch "+this.id+" - "+this.name+" ("+this.effects.length+") Effect(s))"}}]),e}(),ChangeMessage=function(){function e(t,n,s){_classCallCheck(this,e),this.nextMessage=null,s instanceof e?this._constructorMessage(t,n,s):this._constructorDetails(t,n,s)}return _createClass(e,null,[{key:"None",value:function(t){return new e<Multistomp>(MultistompCause.NONE,Details.NONE())}},{key:"For",value:function(t,n){return new e<Multistomp>(MultistompCause.MULTISTOMP,n)}},{key:"For",value:function(t,n,s){var a=new e<Patch>(MultistompCause.PATCH,s),i=new e<Multistomp>(MultistompCause.SUPER,a);return i}},{key:"For",value:function(t,n,s,a){var i=new e<Effect>(MultistompCause.EFFECT,a),r=new e<Patch>(MultistompCause.SUPER,i),u=new e<Multistomp>(MultistompCause.SUPER,r);return u}},{key:"For",value:function(t,n,s,a,i){var r=new e<Param>(MultistompCause.PARAM,i),u=new e<Effect>(MultistompCause.SUPER,r),o=new e<Patch>(MultistompCause.SUPER,u),l=new e<Multistomp>(MultistompCause.SUPER,o);return l}}]),_createClass(e,[{key:"_constructorMessage",value:function(e,t,n){this._ChangeMessageDetails(e,t,Details.NONE()),this.nextMessage=n}},{key:"_constructorDetails",value:function(e,t,n){this.cause=e,this.causer=t,this.details=n}},{key:"causer",value:function(){return this.causer}},{key:"cause",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){return cause})},{key:"details",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){return details})},{key:"nextMessage",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){return nextMessage})},{key:"is",value:function(e){return e.equals(this.realMessage().cause())}},{key:"realMessage",value:function(){for(var e=this;e.cause()==MultistompCause.SUPER;)e=e.nextMessage();return e}},{key:"toString",value:function(){var e="";return e+=this.causer.getClass().getSimpleName(),e+=this.cause==MultistompCause.SUPER?" -> "+this.nextMessage.toString():" ("+this.cause.toString()+")"}}]),e}(),Details=function(){function e(t,n){_classCallCheck(this,e),this.type=t,this.newValue=n}return _createClass(e,[{key:"NONE",value:function(){return new e(TypeChange.NONE,0)}}]),_createClass(e,[{key:"newValue",value:function(){return this.newValue}},{key:"type",value:function(){return this.type}},{key:"toString",value:function(){return"({this.type} {this.newValue})"}}]),e}();Details.TypeChange={NONE:"NONE",PEDAL_STATUS:"PEDAL_STATUS",PARAM:"PARAM",PATCH_NUMBER:"PATCH_NUMBER"};var MultistompCause=function e(){_classCallCheck(this,e)};MultistompCause.SUPER="SUPER",MultistompCause.NONE="NONE",MultistompCause.MULTISTOMP="MULTISTOMP",MultistompCause.PATCH="PATCH",MultistompCause.EFFECT="EFFECT",MultistompCause.PARAM="PARAM";var MultistompSimulator=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this);for(var n=0;e>n;n++){var s=new Patch(n),a=!0,i=!1,r=void 0;try{for(var u,o=this.genEffects()[Symbol.iterator]();!(a=(u=o.next()).done);a=!0){var l=u.value;s.addEffect(l)}}catch(c){i=!0,r=c}finally{try{!a&&o["return"]&&o["return"]()}finally{if(i)throw r}}this.addPatch(s)}}return _inherits(t,e),_createClass(t,[{key:"genEffects",value:function(){var e=new Array;return e.push(this.genEffect(0,"Overdrive")),e.push(this.genEffect(1,"Reverb")),e.push(this.genEffect(2,"Chorus")),e}},{key:"genEffect",value:function(e,t){var n=new Effect(e,t);return n.addParam(new Param("Gain",0,50,0,1)),n.addParam(new Param("Volume",0,25,0,1)),n}},{key:"start",value:function(){return Messages.Empty()}},{key:"getPedalType",value:function(){return PedalType.Null}}]),t}(Multistomp);